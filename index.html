<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鍾孟修-職能治療師討論交流留言板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            padding: 30px;
            text-align: center;
            color: white;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            pointer-events: none;
        }

        .header > * {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .theme-input {
            margin: 20px 0;
        }

        .theme-input input {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            width: 300px;
            max-width: 90%;
            text-align: center;
        }

        .theme-input button {
            padding: 10px 20px;
            background: #fff;
            color: #ff6b6b;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .current-theme {
            font-size: 1.2rem;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 15px;
            display: inline-block;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: #4ecdc4;
            color: white;
        }

        .status-connecting {
            background: #feca57;
            color: #333;
        }

        .status-error {
            background: #ff6b6b;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .message-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .message-form h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .submit-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .visualization {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .viz-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .viz-btn {
            padding: 8px 16px;
            border: 2px solid #4ecdc4;
            background: white;
            color: #4ecdc4;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .viz-btn.active,
        .viz-btn:hover {
            background: #4ecdc4;
            color: white;
        }

        .word-cloud {
            min-height: 200px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .word {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .word:hover {
            transform: scale(1.1);
        }

        .messages-container {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .messages-list {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .message-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #4ecdc4;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        .message-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-author {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #666;
            font-size: 0.9rem;
        }

        .message-content {
            color: #444;
            line-height: 1.6;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4ecdc4;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .list-view {
            display: none;
        }

        .list-view.active {
            display: block;
        }

        .keyword-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .keyword-count {
            background: #4ecdc4;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .setup-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            color: #856404;
        }

        .setup-instructions h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .setup-instructions code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .theme-input input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .theme-input button {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">🔄 連接中...</div>
    
    <div class="container">
        <div class="header">
            <h1>鍾孟修-職能治療師討論交流留言板</h1>
            <p style="margin: 10px 0; font-size: 1.1rem; opacity: 0.9;">歡迎大家自由討論相關話題！</p>
            <div class="theme-input">
                <input type="text" id="themeInput" placeholder="建立新的討論主題..." maxlength="50">
                <button onclick="createTheme()">建立主題</button>
            </div>
            <div class="theme-selector" id="themeSelector" style="margin-top: 15px;">
                <label style="color: white; font-weight: bold;">選擇討論主題：</label>
                <select id="themeSelect" onchange="switchTheme()" style="padding: 8px 15px; border-radius: 20px; border: none; margin-left: 10px; font-size: 1rem;">
                    <option value="一般討論">一般討論</option>
                </select>
            </div>
            <div class="current-theme" id="currentTheme">目前主題：一般討論</div>
            <div style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                💬 多主題討論 • 📱 所有人都可以看到彼此的留言 • ⚡ 即時同步
            </div>
        </div>

        <!-- Firebase設定完成提示 -->
        <div class="setup-instructions" id="setupInstructions" style="display: none;">
            <h3>✅ Firebase設定完成！</h3>
            <p><strong>恭喜！</strong>你的班級留言板已經可以多人同時使用了！</p>
            <p>📱 將此網頁網址製作成QR碼，分享給學生掃描即可開始使用</p>
            <p>💬 所有學生的留言都會即時同步顯示</p>
        </div>

        <div class="main-content">
            <div class="message-form">
                <h3>✍️ 發表留言</h3>
                <form onsubmit="addMessage(event)">
                    <div class="form-group">
                        <label for="authorName">姓名（可選）：</label>
                        <input type="text" id="authorName" placeholder="匿名" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="messageText">留言內容：</label>
                        <textarea id="messageText" placeholder="請輸入您的留言..." required maxlength="500"></textarea>
                    </div>
                    <button type="submit" class="submit-btn" id="submitBtn">📝 發送留言</button>
                </form>
            </div>

            <div class="visualization">
                <h3>📊 留言分析</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMessages">0</div>
                        <div class="stat-label">總留言數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalWords">0</div>
                        <div class="stat-label">總字數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalLikes">0</div>
                        <div class="stat-label">總愛心數</div>
                    </div>
                </div>
                
                <div class="viz-controls">
                    <button class="viz-btn active" onclick="showWordCloud()">文字雲</button>
                    <button class="viz-btn" onclick="showListView()">關鍵字列表</button>
                </div>
                
                <div id="wordCloud" class="word-cloud">
                    <p style="color: #999;">還沒有留言，快來發表第一則留言吧！</p>
                </div>
                
                <div id="listView" class="list-view">
                    <div id="keywordList"></div>
                </div>
            </div>
        </div>

        <div class="messages-container">
            <div class="messages-list">
                <h3>💭 「<span id="themeTitle">一般討論</span>」主題留言</h3>
                <div id="messagesList">
                    <p style="color: #999; text-align: center; padding: 40px;">正在載入留言...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration - 你的Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCC-hrQzsFHNI20omQOxVtckJzdmJV_7Fo",
            authDomain: "matt-e0d2a.firebaseapp.com",
            projectId: "matt-e0d2a",
            storageBucket: "matt-e0d2a.firebasestorage.app",
            messagingSenderId: "913370952002",
            appId: "1:913370952002:web:f650c216eddc4da01218db"
        };

        // Global variables
        let messages = [];
        let allThemes = ['一般討論'];
        let currentTheme = '一般討論';
        let db;
        let app;
        let isFirebaseConfigured = false;

        // Check if Firebase is properly configured
        function checkFirebaseConfig() {
            return firebaseConfig.apiKey !== "your-api-key-here" && 
                   firebaseConfig.projectId !== "your-project-id";
        }

        // Initialize Firebase
        function initFirebase() {
            try {
                if (!checkFirebaseConfig()) {
                    console.log('Firebase未設定，使用本地模式');
                    updateConnectionStatus('error', '⚠️ 需要Firebase設定');
                    document.getElementById('setupInstructions').style.display = 'block';
                    initLocalMode();
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseConfigured = true;
                
                // 隱藏設定說明
                document.getElementById('setupInstructions').style.display = 'none';
                
                updateConnectionStatus('connected', '🟢 已連接');
                
                // 載入主題列表
                loadThemes();
                
                // 監聽留言變化（依主題過濾）
                const messagesQuery = query(collection(db, 'messages'), orderBy('timestamp', 'desc'));
                onSnapshot(messagesQuery, (snapshot) => {
                    const allMessages = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        allMessages.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp.toDate(),
                            likes: data.likes || 0 // 確保愛心數存在
                        });
                    });
                    
                    // 過濾當前主題的留言
                    messages = allMessages.filter(msg => msg.theme === currentTheme);
                    updateDisplay();
                });

                // 監聽主題列表變化
                onSnapshot(collection(db, 'themes'), (snapshot) => {
                    const themes = ['一般討論'];
                    snapshot.forEach((doc) => {
                        const theme = doc.data().name;
                        if (!themes.includes(theme)) {
                            themes.push(theme);
                        }
                    });
                    allThemes = themes;
                    updateThemeSelector();
                });

            } catch (error) {
                console.error('Firebase初始化失敗:', error);
                updateConnectionStatus('error', '❌ 連接失敗');
                initLocalMode();
            }
        }

        // Local mode fallback
        function initLocalMode() {
            isFirebaseConfigured = false;
            updateDisplay();
            showNotification('目前使用本地模式，留言僅在此瀏覽器中顯示', 'warning');
        }

        // Update connection status
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = text;
            statusEl.className = `connection-status status-${status}`;
        }

        // Create new theme
        window.createTheme = async function() {
            const input = document.getElementById('themeInput');
            const theme = input.value.trim();
            if (!theme) return;

            if (allThemes.includes(theme)) {
                showNotification('此主題已存在！', 'warning');
                input.value = '';
                return;
            }

            if (isFirebaseConfigured) {
                try {
                    await addDoc(collection(db, 'themes'), { 
                        name: theme, 
                        createdAt: new Date() 
                    });
                    showNotification('主題建立成功！', 'success');
                    input.value = '';
                } catch (error) {
                    console.error('建立主題失敗:', error);
                    showNotification('建立主題失敗，請稍後重試', 'error');
                }
            } else {
                // Local mode
                if (!allThemes.includes(theme)) {
                    allThemes.push(theme);
                    updateThemeSelector();
                    showNotification('主題已建立（本地模式）', 'warning');
                }
                input.value = '';
            }
        };

        // Switch theme
        window.switchTheme = function() {
            const select = document.getElementById('themeSelect');
            const newTheme = select.value;
            
            if (newTheme !== currentTheme) {
                currentTheme = newTheme;
                document.getElementById('currentTheme').textContent = `目前主題：${currentTheme}`;
                
                if (isFirebaseConfigured) {
                    // 重新載入該主題的留言
                    const messagesQuery = query(collection(db, 'messages'), orderBy('timestamp', 'desc'));
                    onSnapshot(messagesQuery, (snapshot) => {
                        const allMessages = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            allMessages.push({
                                id: doc.id,
                                ...data,
                                timestamp: data.timestamp.toDate()
                            });
                        });
                        
                        // 過濾當前主題的留言
                        messages = allMessages.filter(msg => msg.theme === currentTheme);
                        updateDisplay();
                    }, { includeMetadataChanges: false });
                } else {
                    // Local mode - filter existing messages
                    updateDisplay();
                }
            }
        };

        // Update theme selector
        function updateThemeSelector() {
            const select = document.getElementById('themeSelect');
            const currentValue = select.value;
            
            select.innerHTML = allThemes.map(theme => 
                `<option value="${theme}" ${theme === currentValue ? 'selected' : ''}>${theme}</option>`
            ).join('');
        }

        // Like message function
        window.likeMessage = async function(messageId) {
            if (isFirebaseConfigured) {
                try {
                    const messageRef = doc(db, 'messages', messageId);
                    const messageDoc = await getDoc(messageRef);
                    
                    if (messageDoc.exists()) {
                        const currentLikes = messageDoc.data().likes || 0;
                        await setDoc(messageRef, { likes: currentLikes + 1 }, { merge: true });
                        
                        // 顯示愛心動畫
                        showLikeAnimation(event.target);
                    }
                } catch (error) {
                    console.error('按愛心失敗:', error);
                    showNotification('按愛心失敗，請稍後重試', 'error');
                }
            } else {
                // Local mode
                const messageIndex = messages.findIndex(msg => msg.id == messageId);
                if (messageIndex !== -1) {
                    messages[messageIndex].likes = (messages[messageIndex].likes || 0) + 1;
                    updateDisplay();
                    showLikeAnimation(event.target);
                }
            }
        };

        // Show like animation
        function showLikeAnimation(button) {
            const heart = document.createElement('div');
            heart.innerHTML = '❤️';
            heart.style.cssText = `
                position: absolute;
                pointer-events: none;
                font-size: 1.5rem;
                animation: heartFloat 1s ease-out forwards;
                z-index: 1000;
            `;
            
            const rect = button.getBoundingClientRect();
            heart.style.left = rect.left + 'px';
            heart.style.top = rect.top + 'px';
            
            document.body.appendChild(heart);
            
            setTimeout(() => {
                if (document.body.contains(heart)) {
                    document.body.removeChild(heart);
                }
            }, 1000);
        }
        // Load themes
        async function loadThemes() {
            if (!isFirebaseConfigured) return;
            
            try {
                onSnapshot(collection(db, 'themes'), (snapshot) => {
                    const themes = ['一般討論'];
                    snapshot.forEach((doc) => {
                        const theme = doc.data().name;
                        if (!themes.includes(theme)) {
                            themes.push(theme);
                        }
                    });
                    allThemes = themes;
                    updateThemeSelector();
                });
            } catch (error) {
                console.error('載入主題列表失敗:', error);
            }
        }

        // Add message
        window.addMessage = async function(event) {
            event.preventDefault();
            
            const authorName = document.getElementById('authorName').value.trim() || '匿名';
            const messageText = document.getElementById('messageText').value.trim();
            
            if (!messageText) return;

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '發送中...';

            const message = {
                author: authorName,
                content: messageText,
                timestamp: new Date(),
                theme: currentTheme,
                likes: 0 // 初始化愛心數
            };

            try {
                if (isFirebaseConfigured) {
                    await addDoc(collection(db, 'messages'), message);
                    showNotification('留言發送成功！', 'success');
                } else {
                    // Local mode
                    message.id = Date.now();
                    message.likes = 0; // 初始化愛心數
                    messages.unshift(message);
                    updateDisplay();
                    showNotification('留言已儲存（本地模式）', 'warning');
                }

                // 清空表單
                document.getElementById('authorName').value = '';
                document.getElementById('messageText').value = '';
                
            } catch (error) {
                console.error('發送留言失敗:', error);
                showNotification('發送失敗，請稍後重試', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '📝 發送留言';
            }
        };

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: ${type === 'success' ? '#4ecdc4' : type === 'warning' ? '#feca57' : '#ff6b6b'};
                color: ${type === 'warning' ? '#333' : 'white'};
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1001;
                font-weight: bold;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Update display
        function updateDisplay() {
            updateMessagesList();
            updateStats();
            updateVisualization();
            // 更新留言區標題
            document.getElementById('themeTitle').textContent = currentTheme;
        }

        // Update messages list (filtered by current theme)
        function updateMessagesList() {
            const container = document.getElementById('messagesList');
            
            // 過濾當前主題的留言
            const themeMessages = messages.filter(msg => msg.theme === currentTheme);
            
            if (themeMessages.length === 0) {
                container.innerHTML = `<p style="color: #999; text-align: center; padding: 40px;">「${currentTheme}」主題還沒有留言</p>`;
                return;
            }

            container.innerHTML = themeMessages.map(message => `
                <div class="message-item">
                    <div class="message-header">
                        <span class="message-author">${message.author}</span>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <button class="like-btn" onclick="likeMessage('${message.id}')" style="
                            background: none;
                            border: none;
                            color: #ff6b6b;
                            cursor: pointer;
                            font-size: 1rem;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                            padding: 5px 10px;
                            border-radius: 20px;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#ffe6e6'" onmouseout="this.style.background='none'">
                            <span style="font-size: 1.2rem;">❤️</span>
                            <span>支持 (${message.likes || 0})</span>
                        </button>
                        <div style="color: #999; font-size: 0.8rem;">
                            主題：${message.theme}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update stats (filtered by current theme)
        function updateStats() {
            const themeMessages = messages.filter(msg => msg.theme === currentTheme);
            document.getElementById('totalMessages').textContent = themeMessages.length;
            
            const totalWords = themeMessages.reduce((sum, message) => {
                return sum + message.content.length;
            }, 0);
            document.getElementById('totalWords').textContent = totalWords;
            
            const totalLikes = themeMessages.reduce((sum, message) => {
                return sum + (message.likes || 0);
            }, 0);
            document.getElementById('totalLikes').textContent = totalLikes;
        }

        // Update visualization
        function updateVisualization() {
            const isWordCloudActive = document.querySelector('.viz-btn.active').textContent === '文字雲';
            
            if (isWordCloudActive) {
                generateWordCloud();
            } else {
                generateKeywordList();
            }
        }

        // Show word cloud
        window.showWordCloud = function() {
            document.querySelectorAll('.viz-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.viz-btn')[0].classList.add('active');
            
            document.getElementById('wordCloud').style.display = 'flex';
            document.getElementById('listView').classList.remove('active');
            
            generateWordCloud();
        };

        // Show list view
        window.showListView = function() {
            document.querySelectorAll('.viz-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.viz-btn')[1].classList.add('active');
            
            document.getElementById('wordCloud').style.display = 'none';
            document.getElementById('listView').classList.add('active');
            
            generateKeywordList();
        };

        // Generate word cloud (improved with meaningful complete words)
        function generateWordCloud() {
            const container = document.getElementById('wordCloud');
            
            // 過濾當前主題的留言
            const themeMessages = messages.filter(msg => msg.theme === currentTheme);
            
            if (themeMessages.length === 0) {
                container.innerHTML = `<p style="color: #999;">「${currentTheme}」主題還沒有留言，快來發表第一則留言吧！</p>`;
                return;
            }

            const keywords = extractKeywords();
            const keywordEntries = Object.entries(keywords);
            
            if (keywordEntries.length === 0) {
                container.innerHTML = `<p style="color: #999;">「${currentTheme}」主題的內容還在分析中...</p>`;
                return;
            }

            const colors = [
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', 
                '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd',
                '#00d2d3', '#1dd1a1', '#fd79a8', '#fdcb6e'
            ];
            
            // 只顯示前12個最重要的關鍵字
            container.innerHTML = keywordEntries
                .sort((a, b) => b[1] - a[1])
                .slice(0, 12)
                .map(([word, count], index) => {
                    // 更合理的字體大小計算
                    const maxCount = Math.max(...keywordEntries.map(([, c]) => c));
                    const baseSize = 1.0;
                    const sizeMultiplier = Math.min(count / maxCount * 1.5, 1.8);
                    const size = baseSize + sizeMultiplier;
                    
                    const color = colors[index % colors.length];
                    
                    return `<span class="word" style="
                        font-size: ${size}rem; 
                        background: linear-gradient(45deg, ${color}, ${color}dd); 
                        color: white;
                        margin: 6px;
                        padding: 8px 14px;
                        display: inline-block;
                        border-radius: 20px;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
                        font-weight: ${count >= 3 ? 'bold' : '500'};
                    ">${word} <small style="opacity: 0.9; font-size: 0.7em;">${count}</small></span>`;
                }).join('');
        }

        // Generate keyword list (improved with meaningful words only)
        function generateKeywordList() {
            const container = document.getElementById('keywordList');
            const keywords = extractKeywords();
            
            if (Object.keys(keywords).length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">還沒有關鍵字資料</p>';
                return;
            }

            const sortedKeywords = Object.entries(keywords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15); // 限制顯示數量
            
            // 簡化分類，只按詞頻分組
            const categories = {
                '熱門詞彙': sortedKeywords.filter(([word, count]) => count >= 3),
                '常用詞彙': sortedKeywords.filter(([word, count]) => count === 2),
                '相關詞彙': sortedKeywords.filter(([word, count]) => count === 1)
            };

            let html = '';
            
            Object.entries(categories).forEach(([categoryName, words]) => {
                if (words.length > 0) {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <h4 style="color: #4ecdc4; margin-bottom: 8px; font-size: 0.9rem;">${categoryName}</h4>
                            ${words.slice(0, 8).map(([word, count]) => `
                                <div class="keyword-item" style="margin-bottom: 8px;">
                                    <span style="font-weight: ${count >= 3 ? 'bold' : 'normal'};">${word}</span>
                                    <span class="keyword-count" style="background: ${count >= 3 ? '#ff6b6b' : count === 2 ? '#feca57' : '#96ceb4'};">${count}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });

            container.innerHTML = html || '<p style="color: #999; text-align: center; padding: 20px;">還沒有關鍵字</p>';
        }

        // Extract keywords (improved to show meaningful complete words only)
        function extractKeywords() {
            const keywords = {};
            // 只分析當前主題的留言
            const themeMessages = messages.filter(m => m.theme === currentTheme);
            
            if (themeMessages.length === 0) return keywords;
            
            const allText = themeMessages.map(m => m.content).join(' ');
            
            // 定義有意義的關鍵詞模式（完整詞彙）
            const meaningfulWords = [
                // 職能治療專業術語
                '職能治療', '物理治療', '語言治療', '復健科', '復健', '評估', '訓練', '治療', '療育',
                '認知訓練', '感覺統合', '動作訓練', '功能訓練', '日常生活', '生活自理', '自理能力',
                '精細動作', '粗大動作', '手眼協調', '平衡訓練', '姿勢矯正', '肌力訓練',
                '輔具評估', '輔具', '無障礙', '環境改造', '適應', '獨立', '協助', '支持',
                '發展遲緩', '自閉症', '注意力', '專注力', '記憶力', '學習', '認知',
                '中風', '腦傷', '脊髓損傷', '帕金森', '失智症', '憂鬱症',
                '兒童', '成人', '長者', '老人', '家屬', '照顧者', '患者', '個案',
                // 一般詞彙
                '問題', '困難', '挑戰', '目標', '計畫', '方法', '技巧', '策略',
                '進步', '改善', '效果', '成果', '成功', '失敗', '經驗', '學習',
                '分享', '討論', '交流', '意見', '建議', '想法', '看法', '心得',
                '重要', '有用', '有效', '困難', '容易', '簡單', '複雜',
                '醫院', '診所', '學校', '機構', '中心', '家庭', '社區'
            ];
            
            // 1. 優先匹配完整的有意義詞彙
            meaningfulWords.forEach(word => {
                const regex = new RegExp(word, 'g');
                const matches = allText.match(regex);
                if (matches && matches.length > 0) {
                    keywords[word] = matches.length;
                }
            });
            
            // 2. 如果關鍵字太少，補充一些2-3字的詞組（但要過濾掉重複的部分詞）
            if (Object.keys(keywords).length < 5) {
                const chars = allText.replace(/[^\u4e00-\u9fa5]/g, ''); // 只保留中文
                const usedWords = new Set(Object.keys(keywords));
                
                for (let i = 0; i < chars.length - 1; i++) {
                    for (let len = 2; len <= 3; len++) {
                        if (i + len <= chars.length) {
                            const word = chars.substr(i, len);
                            
                            // 檢查是否已經被更長的詞包含
                            const isPartOfLongerWord = [...usedWords].some(usedWord => 
                                usedWord.includes(word) && usedWord !== word
                            );
                            
                            if (!isPartOfLongerWord && 
                                word.length >= 2 && 
                                !/^(.)\1+$/.test(word) && // 不是重複字符
                                !/[的了在是有和與及]/.test(word)) { // 排除常見虛詞
                                
                                keywords[word] = (keywords[word] || 0) + 1;
                            }
                        }
                    }
                }
            }
            
            // 3. 過濾低頻詞和部分詞
            const filteredKeywords = {};
            Object.entries(keywords).forEach(([word, count]) => {
                // 檢查是否被其他更長的詞包含
                const isPartOfOther = Object.keys(keywords).some(otherWord => 
                    otherWord !== word && 
                    otherWord.includes(word) && 
                    keywords[otherWord] >= count
                );
                
                if (!isPartOfOther && count >= 1) {
                    filteredKeywords[word] = count;
                }
            });
            
            return filteredKeywords;
        }

        // Format time
        function formatTime(date) {
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('connecting', '🔄 連接中...');
            initFirebase();
        });
    </script>
</body>
</html>
